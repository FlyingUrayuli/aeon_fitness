<!-- Cart.vue -->
<template>
  <div class="min-h-screen bg-gray-100 text-gray-900">
    <!-- Fixed Progress Bar -->
    <div  v-if="!orderSummary" class="fixed top-16 left-0 right-0 z-50 bg-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-lg font-bold font-stzongsong">å³å°‡å®Œæˆè¨‚å–®...</h1>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div
            class="bg-blue-600 h-3 rounded-full transition-all duration-500 ease-out"
            :style="{ width: `${(currentStep / 3) * 100}%` }"
          ></div>
        </div>

        <!-- Step Labels -->
        <div class="flex justify-between mt-3 text-sm">
          <span :class="currentStep >= 1 ? 'text-blue-600 font-bold' : 'text-gray-500'">
            ç¢ºèªå•†å“åŠæ•¸é‡
          </span>
          <span :class="currentStep >= 2 ? 'text-blue-600 font-bold' : 'text-gray-500'">
            ç¢ºèªä»˜æ¬¾è³‡è¨Š
          </span>
          <span :class="currentStep >= 3 ? 'text-blue-600 font-bold' : 'text-gray-500'">
            ç¢ºèªæ”¶ä»¶äººè³‡è¨Š
          </span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div :class="{'pt-50': !orderSummary, 'py-8': orderSummary}" class="pb-32 container mx-auto px-4">
      <!-- FinishCart -->
      <div v-if="orderSummary" class="pt-14 max-w-4xl mx-auto space-y-6">
        <div class="text-center mb-8">
          <div class="flex justify-center mb-4">
            <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center">
              <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
          </div>
          <h1 class="text-4xl font-bold font-stzongsong text-green-600 mb-2">æ­å–œå®Œæˆè¨‚å–®ï¼ğŸ‰</h1>
          <p class="text-gray-600 font-stfangsong">æ‚¨çš„è¨‚å–®å·²æˆåŠŸé€å‡ºï¼Œæˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨è™•ç†ã€‚</p>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold font-stzongsong mb-6 text-blue-600">æ”¶ä»¶äººè³‡è¨Š</h2>

          <div class="mb-6">
            <h3 class="text-lg font-bold font-stzongsong mb-4">ä»˜æ¬¾äººè³‡è¨Š</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">å§“åï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payer.name }}</span>
              </div>
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">é›»å­éƒµä»¶ï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payer.email }}</span>
              </div>
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">æ‰‹æ©Ÿï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payer.phone }}</span>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-bold font-stzongsong mb-4">æ”¶ä»¶äººè³‡è¨Š</h3>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <span class="font-stfangsong font-semibold text-gray-700">å§“åï¼š</span>
                  <span class="font-stfangsong">{{ orderSummary.recipient.name }}</span>
                </div>
                <div>
                  <span class="font-stfangsong font-semibold text-gray-700">é›»å­éƒµä»¶ï¼š</span>
                  <span class="font-stfangsong">{{ orderSummary.recipient.email }}</span>
                </div>
                <div>
                  <span class="font-stfangsong font-semibold text-gray-700">æ‰‹æ©Ÿï¼š</span>
                  <span class="font-stfangsong">{{ orderSummary.recipient.phone }}</span>
                </div>
                <div v-if="orderSummary.recipient.taxId">
                  <span class="font-stfangsong font-semibold text-gray-700">çµ±ä¸€ç·¨è™Ÿï¼š</span>
                  <span class="font-stfangsong">{{ orderSummary.recipient.taxId }}</span>
                </div>
              </div>
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">åœ°å€ï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.recipient.address }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold font-stzongsong mb-6 text-purple-600">ä»˜æ¬¾è³‡è¨Š</h2>

          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">ä»˜æ¬¾äººå§“åï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payment.name }}</span>
              </div>
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">ä»˜æ¬¾æ–¹å¼ï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payment.method === 'credit' ? 'ä¿¡ç”¨å¡' : 'ATMè½‰å¸³' }}</span>
              </div>
            </div>

            <div v-if="orderSummary.payment.method === 'credit'" class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">å¡è™Ÿï¼š</span>
                <span class="font-stfangsong">**** **** **** {{ orderSummary.payment.cardNumber.slice(-4) }}</span>
              </div>
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">åˆ°æœŸæ—¥ï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payment.expiryDate }}</span>
              </div>
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">é©—è­‰ç¢¼ï¼š</span>
                <span class="font-stfangsong">***</span>
              </div>
            </div>

            <div v-if="orderSummary.payment.method === 'atm'">
              <div>
                <span class="font-stfangsong font-semibold text-gray-700">éŠ€è¡Œå¸³è™Ÿï¼š</span>
                <span class="font-stfangsong">{{ orderSummary.payment.bankAccount }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold font-stzongsong mb-6 text-green-600">è¨‚å–®å•†å“</h2>

          <div v-for="(item, index) in orderSummary.items" :key="index" class="border-b pb-4 mb-4 last:border-b-0 last:mb-0">
            <div class="flex items-center gap-4">
              <img :src="item.image" :alt="item.name" class="w-20 h-20 object-cover rounded-lg">
              <div class="flex-1">
                <h3 class="font-bold font-stzongsong text-lg">{{ item.name }}</h3>
                <p class="text-gray-600 font-stfangsong">{{ item.slogan }}</p>
                <p class="text-sm text-gray-500 font-stfangsong">æ•¸é‡: {{ item.quantity }}</p>
              </div>
              <span class="font-bold text-lg text-blue-600">NT$ {{ (item.price * item.quantity).toLocaleString() }}</span>
            </div>
          </div>

          <div class="text-right border-t pt-4 mt-4">
            <span class="text-2xl font-bold font-stzongsong">ç¸½è¨ˆï¼šNT$ {{ orderSummary.total.toLocaleString() }}</span>
          </div>
        </div>

        <div class="text-center mt-8">
          <button
            @click="goToProducts"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300"
          >
            ç¹¼çºŒè³¼ç‰©
          </button>
        </div>
      </div>
      <!-- Empty Cart State -->
      <div v-else-if="!orderSummary && cartItems.length === 0" class="text-center py-20">
        <div class="max-w-md mx-auto">
          <svg class="w-20 h-20 text-gray-400 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.8 9M7 13l-1.8 9m0 0h13.6M7 13h13.6M7 13L5.4 5M7 13l-1.8 9"/>
          </svg>
          <h2 class="text-2xl font-bold font-stzongsong mb-4">æ‚¨é‚„æœªé¸è³¼ä»»ä½•å•†å“</h2>
          <button
            @click="$router.push('/products')"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300"
          >
            ç¹¼çºŒé¸è³¼...
          </button>
        </div>
      </div>

      <!-- Cart Content -->
      <div v-else-if="!orderSummary">
        <!-- Step 1: ç¢ºèªå•†å“åŠæ•¸é‡ -->
        <div v-show="currentStep === 1" class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-bold font-stzongsong mb-6">ç¢ºèªå•†å“åŠæ•¸é‡</h2>

          <div v-for="(item, index) in cartItems" :key="index" class="border-b pb-6 mb-6 last:border-b-0">
            <div class="flex flex-col md:flex-row gap-6">
              <!-- Product Image -->
              <div class="w-full md:w-1/4">
                <img :src="item.image" :alt="item.name" class="w-full h-48 object-cover rounded-lg">
              </div>

              <!-- Product Info -->
              <div class="flex-1">
                <h3 class="text-xl font-bold font-stzongsong mb-2">{{ item.name }}</h3>
                <p class="text-gray-600 font-stfangsong mb-4">{{ item.slogan }}</p>

                <!-- Quantity Controls -->
                <div class="flex items-center gap-4 mb-4">
                  <span class="font-stfangsong">æ•¸é‡ï¼š</span>
                  <button
                    @click="decreaseQuantity(index)"
                    class="cursor-pointer font-bold pb-1 bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-full flex items-center justify-center"
                  >
                    -
                  </button>
                  <span class="w-8 text-center font-bold">{{ item.quantity }}</span>
                  <button
                    @click="increaseQuantity(index)"
                    class="cursor-pointer font-bold pb-1 bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-full flex items-center justify-center"
                  >
                    +
                  </button>
                </div>

                <!-- Price -->
                <div class="text-right">
                  <span class="text-2xl font-bold text-blue-600">NT$ {{ (item.price * item.quantity).toLocaleString() }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Total -->
          <div class="text-right border-t pt-4">
            <span class="text-2xl font-bold font-stzongsong">ç¸½è¨ˆï¼šNT$ {{ totalAmount.toLocaleString() }}</span>
          </div>
        </div>

        <!-- Step 2: ç¢ºèªä»˜æ¬¾è³‡è¨Š -->
        <div v-show="currentStep === 2" class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-bold font-stzongsong mb-6">ç¢ºèªä»˜æ¬¾è³‡è¨Š</h2>

          <div class="space-y-6">
            <!-- Payment Name -->
            <div>
              <label class="block font-stfangsong font-semibold mb-2">ä»˜æ¬¾äººå§“å *</label>
              <input
                v-model="paymentInfo.name"
                :class="['w-full px-4 py-2 border rounded-lg', paymentNameError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                placeholder="è«‹è¼¸å…¥ä»˜æ¬¾äººå§“å"
                ref="paymentNameInput"
              >
            </div>

            <!-- Payment Method -->
            <div>
              <label class="block font-stfangsong font-semibold mb-2">ä»˜æ¬¾æ–¹å¼ *</label>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input
                    v-model="paymentInfo.method"
                    type="radio"
                    value="credit"
                    class="mr-2"
                  >
                  <span class="font-stfangsong">ä¿¡ç”¨å¡</span>
                </label>
                <label class="flex items-center">
                  <input
                    v-model="paymentInfo.method"
                    type="radio"
                    value="atm"
                    class="mr-2"
                  >
                  <span class="font-stfangsong">ATMè½‰å¸³</span>
                </label>
              </div>
            </div>

            <!-- Credit Card Info -->
            <div v-if="paymentInfo.method === 'credit'" class="space-y-4">
              <div>
                <label class="block font-stfangsong font-semibold mb-2">ä¿¡ç”¨å¡å¡è™Ÿ *</label>
                <input
                  v-model="paymentInfo.cardNumber"
                  :class="['w-full px-4 py-2 border rounded-lg', cardNumberError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="1234 5678 9012 3456"
                  maxlength="19"
                  ref="cardNumberInput"
                >
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block font-stfangsong font-semibold mb-2">åˆ°æœŸæ—¥ *</label>
                  <input
                    v-model="paymentInfo.expiryDate"
                    :class="['w-full px-4 py-2 border rounded-lg', expiryDateError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                    placeholder="MM/YY"
                    maxlength="5"
                    ref="expiryDateInput"
                  >
                </div>
                <div>
                  <label class="block font-stfangsong font-semibold mb-2">é©—è­‰ç¢¼ *</label>
                  <input
                    v-model="paymentInfo.cvv"
                    :class="['w-full px-4 py-2 border rounded-lg', cvvError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                    placeholder="123"
                    maxlength="3"
                    ref="cvvInput"
                  >
                </div>
              </div>
            </div>

            <!-- Bank Account Info -->
            <div v-if="paymentInfo.method === 'atm'">
              <label class="block font-stfangsong font-semibold mb-2">éŠ€è¡Œå¸³è™Ÿ *</label>
              <input
                v-model="paymentInfo.bankAccount"
                :class="['w-full px-4 py-2 border rounded-lg', bankAccountError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                placeholder="è«‹è¼¸å…¥éŠ€è¡Œå¸³è™Ÿ"
                ref="bankAccountInput"
              >
            </div>

            <!-- Warning -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <p class="text-sm font-stfangsong text-yellow-800">
                <strong>è­¦èªï¼š</strong>è«‹ç¢ºèªæ‚¨çš„ä»˜æ¬¾è³‡è¨Šæ­£ç¢ºç„¡èª¤ã€‚å®Œæˆè¨‚å–®å¾Œï¼Œæˆ‘å€‘å°‡ä¾ç…§æ‚¨æä¾›çš„è³‡è¨Šé€²è¡Œä»˜æ¬¾è™•ç†ã€‚
              </p>
            </div>
          </div>
        </div>

        <!-- Step 3: ç¢ºèªæ”¶ä»¶äººè³‡è¨Š -->
        <div v-show="currentStep === 3" class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h2 class="text-2xl font-bold font-stzongsong mb-6">ç¢ºèªæ”¶ä»¶äººè³‡è¨Š</h2>

          <!-- Payer Info -->
          <div class="mb-8">
            <h3 class="text-lg font-bold font-stzongsong mb-4">ä»˜æ¬¾äººè³‡è¨Š</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block font-stfangsong font-semibold mb-2">å§“å *</label>
                <input
                  v-model="payerInfo.name"
                  :class="['w-full px-4 py-2 border rounded-lg', payerNameError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="è«‹è¼¸å…¥å§“å"
                  :ref="(el) => setPayerInfoRef(el, 'payerName')"
                >
              </div>
              <div>
                <label class="block font-stfangsong font-semibold mb-2">é›»å­éƒµä»¶ *</label>
                <input
                  v-model="payerInfo.email"
                  :class="['w-full px-4 py-2 border rounded-lg', payerEmailError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="example@email.com"
                  type="email"
                  :ref="(el) => setPayerInfoRef(el, 'payerEmail')"
                >
              </div>
              <div>
                <label class="block font-stfangsong font-semibold mb-2">æ‰‹æ©Ÿ *</label>
                <input
                  v-model="payerInfo.phone"
                  :class="['w-full px-4 py-2 border rounded-lg', payerPhoneError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="0912345678"
                  :ref="(el) => setPayerInfoRef(el, 'payerPhone')"
                >
              </div>
            </div>
          </div>

          <!-- Recipient Info -->
          <div>
            <div class="flex items-center mb-4">
              <h3 class="text-lg font-bold font-stzongsong mr-4">æ”¶ä»¶äººè³‡è¨Š</h3>
              <label class="flex items-center">
                <input
                  v-model="sameAsPayer"
                  type="checkbox"
                  class="mr-2"
                  @change="toggleSameAsPayer"
                >
                <span class="font-stfangsong">èˆ‡ä»˜æ¬¾äººç›¸åŒ</span>
              </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block font-stfangsong font-semibold mb-2">å§“å *</label>
                <input
                  v-model="recipientInfo.name"
                  :class="['w-full px-4 py-2 border rounded-lg', recipientNameError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="è«‹è¼¸å…¥å§“å"
                  :ref="(el) => setRecipientInfoRef(el, 'recipientName')"
                >
              </div>
              <div>
                <label class="block font-stfangsong font-semibold mb-2">é›»å­éƒµä»¶ *</label>
                <input
                  v-model="recipientInfo.email"
                  :class="['w-full px-4 py-2 border rounded-lg', recipientEmailError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="example@email.com"
                  type="email"
                  :ref="(el) => setRecipientInfoRef(el, 'recipientEmail')"
                >
              </div>
              <div>
                <label class="block font-stfangsong font-semibold mb-2">æ‰‹æ©Ÿ *</label>
                <input
                  v-model="recipientInfo.phone"
                  :class="['w-full px-4 py-2 border rounded-lg', recipientPhoneError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                  placeholder="0912345678"
                  :ref="(el) => setRecipientInfoRef(el, 'recipientPhone')"
                >
              </div>
              <div>
                <label class="block font-stfangsong font-semibold mb-2">çµ±ä¸€ç·¨è™Ÿ</label>
                <input
                  v-model="recipientInfo.taxId"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  placeholder="12345678 (é¸å¡«)"
                >
              </div>
            </div>

            <div class="mt-4">
              <label class="block font-stfangsong font-semibold mb-2">åœ°å€ *</label>
              <textarea
                v-model="recipientInfo.address"
                :class="['w-full px-4 py-2 border rounded-lg', recipientAddressError ? 'border-red-500 animate-pulse' : 'border-gray-300']"
                placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
                rows="3"
                :ref="(el) => setRecipientInfoRef(el, 'recipientAddress')"
              ></textarea>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Next Button -->
    <div v-if="!orderSummary && cartItems.length > 0" class="bottom-0 left-0 right-0 bg-white border-t shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <button v-if="currentStep > 1" @click="prevStep" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-lg transition-colors duration-300">
            ä¸Šä¸€æ­¥
          </button>
          <div v-else></div>
          <button
            @click="nextStep"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300"
          >
            {{ currentStep === 3 ? 'å®Œæˆè¨‚å–®' : 'Next' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { nextTick } from 'vue'; //  ç”¨æ–¼ DOM æ›´æ–°å¾Œçš„æ»¾å‹•
import { useRouter, useRoute } from 'vue-router'
import { products } from '../data/product.js'

const router = useRouter()
const route = useRoute()

// Reactive data
const orderSummary = ref(null); // å„²å­˜è¨‚å–®æ‘˜è¦è³‡è¨Š
const currentStep = ref(1)

// â• æ–°å¢ï¼šç”¨æ–¼æ»¾å‹•åˆ°éŒ¯èª¤æ¬„ä½çš„ refs
const paymentNameInput = ref(null);
const cardNumberInput = ref(null);
const expiryDateInput = ref(null);
const cvvInput = ref(null);
const bankAccountInput = ref(null);
const payerInfoInputs = ref({}); // ç”¨æ–¼payerInfoçš„å‹•æ…‹ref
const recipientInfoInputs = ref({}); // ç”¨æ–¼recipientInfoçš„å‹•æ…‹ref

// å‹•æ…‹è¨­å®š ref çš„ helper å‡½æ•¸
const setPayerInfoRef = (el, fieldName) => {
  if (el) payerInfoInputs.value[fieldName] = el;
};
const setRecipientInfoRef = (el, fieldName) => {
  if (el) recipientInfoInputs.value[fieldName] = el;
};

const cartItems = ref([])
const sameAsPayer = ref(false)

// Form data
const paymentInfo = ref({
  name: '',
  method: '',
  cardNumber: '',
  expiryDate: '',
  cvv: '',
  bankAccount: ''
})

const payerInfo = ref({
  name: '',
  email: '',
  phone: ''
})

const recipientInfo = ref({
  name: '',
  email: '',
  phone: '',
  address: '',
  taxId: ''
})

// Error states
const paymentNameError = ref(false)
const cardNumberError = ref(false)
const expiryDateError = ref(false)
const cvvError = ref(false)
const bankAccountError = ref(false)
const payerNameError = ref(false)
const payerEmailError = ref(false)
const payerPhoneError = ref(false)
const recipientNameError = ref(false)
const recipientEmailError = ref(false)
const recipientPhoneError = ref(false)
const recipientAddressError = ref(false)

// Computed
const totalAmount = computed(() => {
  return cartItems.value.reduce((total, item) => total + (item.price * item.quantity), 0)
})

// Methods
const addToCart = (productId) => {
  const product = products.find(p => p.id === productId)
  if (product) {
    const existingItem = cartItems.value.find(item => item.id === productId)
    if (existingItem) {
      existingItem.quantity += 1
    } else {
      cartItems.value.push({
        id: product.id,
        name: product.name,
        slogan: product.slogan,
        image: product.image[0],
        price: product.price,
        quantity: 1
      })
    }
  }
}

const increaseQuantity = (index) => {
  cartItems.value[index].quantity += 1
}

const decreaseQuantity = (index) => {
  if (cartItems.value[index].quantity > 1) {
    cartItems.value[index].quantity -= 1
  }
}

const toggleSameAsPayer = () => {
  if (sameAsPayer.value) {
    recipientInfo.value.name = payerInfo.value.name
    recipientInfo.value.email = payerInfo.value.email
    recipientInfo.value.phone = payerInfo.value.phone
  } else {
    recipientInfo.value.name = ''
    recipientInfo.value.email = ''
    recipientInfo.value.phone = ''
  }
}

const clearErrors = () => {
  paymentNameError.value = false
  cardNumberError.value = false
  expiryDateError.value = false
  cvvError.value = false
  bankAccountError.value = false
  payerNameError.value = false
  payerEmailError.value = false
  payerPhoneError.value = false
  recipientNameError.value = false
  recipientEmailError.value = false
  recipientPhoneError.value = false
  recipientAddressError.value = false
}

const validateStep1 = () => {
  return cartItems.value.length > 0
}

const validateStep2 = () => {
   clearErrors();
 let isValid = true;
 let firstErrorElement = null;

 const checkField = (field, errorRef, elementRef) => {
    if (!field.trim()) {
        errorRef.value = true;
        isValid = false;
        if (!firstErrorElement) {
          firstErrorElement = elementRef;
        }
    }
 };

    checkField(paymentInfo.value.name, paymentNameError, paymentNameInput.value);

 if (paymentInfo.value.method === 'credit') {
    checkField(paymentInfo.value.cardNumber, cardNumberError, cardNumberInput.value);
    checkField(paymentInfo.value.expiryDate, expiryDateError, expiryDateInput.value);
    checkField(paymentInfo.value.cvv, cvvError, cvvInput.value);
 } else if (paymentInfo.value.method === 'atm') {
    checkField(paymentInfo.value.bankAccount, bankAccountError, bankAccountInput.value);
 } else {
 // å¦‚æœæ²’æœ‰é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼Œä¹Ÿç®—ä½œéŒ¯èª¤ï¼Œä½†æ²’æœ‰å°æ‡‰çš„è¼¸å…¥æ¡†æ»¾å‹•
    isValid = false;
 }

 if (!isValid && firstErrorElement) {
    nextTick(() => {
    firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
 });
 }

 return isValid;
}

const validateStep3 = () => {
  clearErrors();
  let isValid = true;
  let firstErrorElement = null;

  const checkField = (field, errorRef, inputName, isRecipient = false) => {
    if (!field.trim()) {
      errorRef.value = true;
      isValid = false;
      if (!firstErrorElement) {
        // ä½¿ç”¨å‹•æ…‹refä¾†ç²å–å…ƒç´ 
        if (isRecipient) {
          firstErrorElement = recipientInfoInputs.value[inputName];
        } else {
          firstErrorElement = payerInfoInputs.value[inputName];
        }
      }
    }
  };

  // ä»˜æ¬¾äººè³‡è¨Š
  checkField(payerInfo.value.name, payerNameError, 'payerName');
  checkField(payerInfo.value.email, payerEmailError, 'payerEmail');
  checkField(payerInfo.value.phone, payerPhoneError, 'payerPhone');

    // æ”¶ä»¶äººè³‡è¨Š
  checkField(recipientInfo.value.name, recipientNameError, 'recipientName', true);
  checkField(recipientInfo.value.email, recipientEmailError, 'recipientEmail', true);
  checkField(recipientInfo.value.phone, recipientPhoneError, 'recipientPhone', true);
  checkField(recipientInfo.value.address, recipientAddressError, 'recipientAddress', true);

   if (!isValid && firstErrorElement) {
    nextTick(() => {
      firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
 }
 return isValid;
}

const nextStep = () => {
  if (currentStep.value === 1) {
    if (validateStep1()) {
      currentStep.value = 2;
      window.scrollTo({ top: 0, behavior: 'smooth' }); // æ»¾å‹•åˆ°é ‚éƒ¨
    }
  } else if (currentStep.value === 2) {
    if (validateStep2()) {
      currentStep.value = 3;
      window.scrollTo({ top: 0, behavior: 'smooth' }); // æ»¾å‹•åˆ°é ‚éƒ¨
    }
  } else if (currentStep.value === 3) {
    if (validateStep3()) {
      // Navigate to FinishCart with order data
      const orderData = {
        items: cartItems.value,
        payment: paymentInfo.value,
        payer: payerInfo.value,
        recipient: recipientInfo.value,
        total: totalAmount.value
      }

      // è¨­å®š orderSummary é¡¯ç¤ºè¨‚å–®å®Œæˆé é¢
      orderSummary.value = orderData;
      // æ¸…ç©ºè³¼ç‰©è»Šï¼Œæ¨¡æ“¬è¨‚å–®å®Œæˆä¸¦é‡ç½®ç‹€æ…‹
      cartItems.value = [];
      currentStep.value = 1; // é‡ç½®æ­¥é©Ÿæ¢
      clearErrors(); // æ¸…ç©ºæ‰€æœ‰éŒ¯èª¤ç‹€æ…‹
      // æ¸…ç©ºè¡¨å–®æ•¸æ“š
      paymentInfo.value = { name: '', method: '', cardNumber: '', expiryDate: '', cvv: '', bankAccount: '' };
      payerInfo.value = { name: '', email: '', phone: '' };
      recipientInfo.value = { name: '', email: '', phone: '', address: '', taxId: '' };
      sameAsPayer.value = false;

      // æ»¾å‹•åˆ°é é¢é ‚éƒ¨ä»¥é¡¯ç¤ºè¨‚å–®å®Œæˆè¨Šæ¯
      nextTick(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }
  }
}
// ä¸Šä¸€æ­¥åŠŸèƒ½
const prevStep = () => {
  if (currentStep.value > 1) {
    currentStep.value--;
    window.scrollTo({ top: 0, behavior: 'smooth' }); // æ»¾å‹•åˆ°é é¢é ‚éƒ¨
  }
};
// è·³è½‰å›å•†å“é é¢æ–¹æ³•
const goToProducts = () => {
  // ç¢ºä¿æ¸…ç©º orderSummary æ‰èƒ½å›åˆ°è³¼ç‰©è»Šæµç¨‹
  orderSummary.value = null;
  router.push('/products');
};
// Lifecycle
onMounted(() => {
  // Check if coming from ProductDetail with a product to add
  const productId = route.query.product
  if (productId) {
    addToCart(productId)
  }
  // å¦‚æœå¾å…¶ä»–é é¢å›ä¾†ä¸” sessionStorage ä¸­æœ‰è¨‚å–®æ•¸æ“šï¼Œå‰‡é¡¯ç¤ºè¨‚å–®æ‘˜è¦
  const storedOrderData = sessionStorage.getItem('orderData');
  if (storedOrderData) {
    orderSummary.value = JSON.parse(storedOrderData);
  // æ¸…é™¤ sessionStorage ä¸­çš„è¨‚å–®æ•¸æ“šï¼Œé¿å…ä¸‹æ¬¡é€²å…¥æ™‚ç›´æ¥é¡¯ç¤ºå®Œæˆé 
    sessionStorage.removeItem('orderData');
  }

});

</script>

<style scoped>
.font-stfangsong {
  font-family: 'STFangsong', 'FangSong', serif;
}

.font-stzongsong {
  font-family: 'STZhongsong', 'SimSun', serif;
}

.animate-pulse {
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
